import bpy
print("\n\n\n--------------------script starts--------------------")
# Variables
parent_empty_name = "piping"

# Get the selected empty
selected_empty = bpy.context.object
if selected_empty.type != 'EMPTY':
    raise ValueError("Selected object is not an empty.")

# Get the first-level empties under the selected empty
first_level_empties = [
    child for child in selected_empty.children
    if child.type == 'EMPTY'
]

# Loop through the first-level empties
for first_level_empty in first_level_empties:
    # Create a list to store the meshes
    meshes_to_merge = []

    # Function to recursively find meshes under an empty
    def find_meshes(empty):
        for child in empty.children:
            if child.type == 'EMPTY':
                find_meshes(child)
            elif child.type == 'MESH':
                meshes_to_merge.append(child)

    # Find meshes under the current first-level empty
    find_meshes(first_level_empty)

    # Check if meshes are available to join
    if len(meshes_to_merge) > 0:
        # Merge the meshes
        bpy.ops.object.select_all(action='DESELECT')
        for mesh in meshes_to_merge:
            mesh.select_set(True)
        bpy.context.view_layer.objects.active = meshes_to_merge[0]
        bpy.ops.object.join()

        # Rename the merged mesh
        merged_mesh = bpy.context.object
        
        originalName = first_level_empty.name
        first_level_empty.name = first_level_empty.name + ".001"
        merged_mesh.name = originalName
        print("Merged mesh name ://", merged_mesh.name)
        print("empty name       ://", first_level_empty.name, "\n\n")
        
        # Get the existing parent empty
        parent_empty = bpy.data.objects.get(parent_empty_name)
        if parent_empty is None or parent_empty.type != 'EMPTY':
            raise ValueError("Existing parent empty not found or is not an empty.")

        # Parent the merged mesh to the existing parent empty
        merged_mesh.parent = parent_empty
        #print(merged_mesh.name)

# Clean up the selection
bpy.ops.object.select_all(action='DESELECT')
selected_empty.select_set(True)
bpy.context.view_layer.objects.active = selected_empty
print("--------------------script ends--------------------")